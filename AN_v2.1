javascript:(function () {
  'use strict';

  const $ = window.jQuery;
  if (!$) { alert('KZ: chybí jQuery (nejsi v herním UI?)'); return; }

  const ScriptData = { name: "KZ – Auto poznámky z oznamky (CZ)", version: "v0.1" };
  const T = {
    verifyReportPage: "Skript musíš spustit v detailu oznamky (report).",
    noteCreated: "Poznámka uložena",
    chooseSide: "Zapsat report ke které vesnici?",
    attacker: "Útočník",
    defender: "Obránce",
    unknown: "Neznámé",
    offensive: "Off",
    defensive: "Deff",
    probOffensive: "Spíš off",
    probDefensive: "Spíš deff",
    noSurvivors: "Nic nepřežilo",
    sent: "Poslal",
    died: "Padlo",
    survived: "Přežilo",
    home: "Měl doma",
    away: "Měl mimo",
    died100: "Padlo (100%)",
  };

  // --- report page check (podobně jako originál) ---
  function verifyReportPage() {
    const m = window.location.href.match(/screen=report|view=report|screen=report_view|mode=report/);
    if (!m) { UI.ErrorMessage(T.verifyReportPage, 5000); return false; }
    // DK většinou používá #attack_info_att / #attack_info_def jen v reportu
    if (!$('#attack_info_att').length || !$('#attack_info_def').length) { UI.ErrorMessage(T.verifyReportPage, 5000); return false; }
    return true;
  }

  const GD = window.game_data;
  const ME = GD?.player?.name ? String(GD.player.name) : '';
  const sitter = String(GD?.player?.sitter ?? '0') !== '0';

  // --- units ordering / archers ---
  const hasArcher = Array.isArray(GD?.units) && GD.units.includes('archer');
  const UNIT_KEYS = hasArcher
    ? ['spear','sword','axe','archer','spy','light','marcher','heavy','ram','catapult']
    : ['spear','sword','axe','spy','light','heavy','ram','catapult'];

  // farm per unit index (stejná myšlenka jako originál)
  const FARM = hasArcher ? [1,1,1,1,2,4,5,6,5,8] : [1,1,1,2,4,6,5,8];

  // indexy off/deff jednotek (heuristika)
  function calcOffDeffFarm(vec) {
    let off = 0, deff = 0;
    for (let i = 0; i < vec.length; i++) {
      const n = vec[i] || 0;
      // off: axe, light, marcher, ram, catapult (plus archer? ne)
      // deff: spear, sword, archer, heavy, spy (spy ignorujeme do deff)
      if (hasArcher) {
        // indexes: 0 spear,1 sword,2 axe,3 archer,4 spy,5 light,6 marcher,7 heavy,8 ram,9 catapult
        if (i === 2 || i === 5 || i === 6 || i === 8 || i === 9) off += n * FARM[i];
        if (i === 0 || i === 1 || i === 3 || i === 7) deff += n * FARM[i];
      } else {
        // 0 spear,1 sword,2 axe,3 spy,4 light,5 heavy,6 ram,7 catapult
        if (i === 2 || i === 4 || i === 6 || i === 7) off += n * FARM[i];
        if (i === 0 || i === 1 || i === 5) deff += n * FARM[i];
      }
    }
    return { off, deff };
  }

  function classify(vec, contextLabel) {
    const { off, deff } = calcOffDeffFarm(vec);
    if (!vec.some(v => v > 0)) return { text: T.noSurvivors, color: '#888888', score: 0.0, tag: 'mix' };

    // “0.1..1.0” – orientačně, jen ať to vypadá jak originál
    // off škálujeme na 15000 farm, deff na 20000 farm (můžeš později doladit)
    const offScore = Math.min(1, off / 15000);
    const deffScore = Math.min(1, deff / 20000);

    if (off > deff) {
      const score = Math.round(offScore * 10) / 10;
      const text = (off > 3000) ? T.offensive : T.probOffensive;
      return { text, color: '#ff0000', score, tag: 'off' };
    } else {
      const score = Math.round(deffScore * 10) / 10;
      const text = (deff > 1000) ? T.defensive : T.probDefensive;
      return { text, color: '#0eae0e', score, tag: 'deff' };
    }
  }

  function parseVecFromUnitsTable(tableSel, rowIndex1based) {
    // v reportu je to obvykle: tr(2)=Počet/Vesnice, tr(3)=Ztráty
    const tds = $(`${tableSel} > tbody > tr:nth-child(${rowIndex1based}) > td.unit-item`);
    if (!tds.length) return null;
    const vec = [];
    tds.each((i, el) => {
      if (i < UNIT_KEYS.length) vec[i] = parseInt((el.textContent || '0').trim(), 10) || 0;
    });
    // doplň na délku
    while (vec.length < UNIT_KEYS.length) vec.push(0);
    return vec;
  }

  function vecSub(a, b) {
    const out = [];
    for (let i = 0; i < Math.max(a.length, b.length); i++) out[i] = Math.max(0, (a[i] || 0) - (b[i] || 0));
    return out;
  }

  function vecEqual(a, b) {
    for (let i = 0; i < Math.max(a.length, b.length); i++) if ((a[i] || 0) !== (b[i] || 0)) return false;
    return true;
  }

  function fmtLine(label, vec) {
    const parts = [];
    for (let i = 0; i < UNIT_KEYS.length; i++) {
      const n = vec[i] || 0;
      if (n > 0) parts.push(`[unit]${UNIT_KEYS[i]}[/unit] ${n}`);
    }
    return `[b]${label}:[/b] ${parts.length ? parts.join(' ') : '—'}`;
  }

  function getNamesAndVillageIds() {
    const attName = $('#attack_info_att > tbody > tr:nth-child(1) > th:nth-child(2) > a').text().trim();
    const defName = $('#attack_info_def > tbody > tr:nth-child(1) > th:nth-child(2) > a').text().trim();

    // village id je v odkazu info_village&id=...
    const attHref = $('#attack_info_att > tbody > tr:nth-child(2) > td:nth-child(2) a[href*="screen=info_village"][href*="id="]').attr('href') || '';
    const defHref = $('#attack_info_def > tbody > tr:nth-child(2) > td:nth-child(2) a[href*="screen=info_village"][href*="id="]').attr('href') || '';

    const attId = (attHref.match(/[?&]id=(\d+)/) || [])[1] || '-1';
    const defId = (defHref.match(/[?&]id=(\d+)/) || [])[1] || '-1';

    const attCoord = ($('#attack_info_att').text().match(/(\d{3}\|\d{3})/) || [])[1] || '';
    const defCoord = ($('#attack_info_def').text().match(/(\d{3}\|\d{3})/) || [])[1] || '';

    return { attName, defName, attId, defId, attCoord, defCoord };
  }

  function buildNoteBlock(targetCoord, headerInfo, lines, exportCodeOptional) {
    // headerInfo: {text,color,score,tag}
    const scoreTxt = (headerInfo.score ?? 0).toFixed(1);
    const head = `[b][coord]${targetCoord}[/coord][/b] | [color=${headerInfo.color}][b]${scoreTxt} ${headerInfo.tag}[/b][/color] | [i]${headerInfo.text}[/i]`;
    // export kód nechávám vypnutý (ty chceš vlastní řádky), ale můžeš zapnout později:
    return `${head}\n${lines.join('\n')}${exportCodeOptional ? `\n\n${exportCodeOptional}` : ''}`;
  }

  function apiNoteEdit(villageId, noteText) {
    // stejný endpoint jako originál
    const base = `https://${location.hostname}/game.php?village=${GD.village.id}&screen=api&ajaxaction=village_note_edit`;
    const url = sitter
      ? `${base}&t=${GD.player.id}`
      : `${base}&h=${GD.csrf}&client_time=${Math.round(Timing.getCurrentServerTime() / 1000)}`;

    return $.post(url, { note: noteText, village_id: villageId, h: GD.csrf });
  }

  function runForSide(side /* 'att' or 'def' */) {
    const { attName, defName, attId, defId, attCoord, defCoord } = getNamesAndVillageIds();

    const iAmDef = (defName === ME);
    const iAmAtt = (attName === ME);

    // Když explicitně zvolíš side, tak target = side villageId/coords
    const targetId = side === 'att' ? attId : defId;
    const targetCoord = side === 'att' ? attCoord : defCoord;

    // Troop tabulky:
    // attacker units: #attack_info_att_units
    // defender units: #attack_info_def_units
    const tabSel = side === 'att' ? '#attack_info_att_units' : '#attack_info_def_units';

    const row2 = parseVecFromUnitsTable(tabSel, 2); // Počet / Vesnice
    const row3 = parseVecFromUnitsTable(tabSel, 3); // Ztráty
    if (!row2 || !row3) {
      UI.ErrorMessage('KZ: Nenašel jsem řádky jednotek (Počet/Ztráty).', 4000);
      return;
    }
    const surv = vecSub(row2, row3);

    // mimo vesnici (jen u obránce, pokud existuje špeh tabulka)
    let away = null;
    if (side === 'def' && $('#attack_spy_away').length) {
      // v #attack_spy_away je obvykle: tr(2) > td > table ... tr(2) > td (čísla)
      const tds = $('#attack_spy_away > tbody > tr:nth-child(2) > td table tbody tr:nth-child(2) > td');
      if (tds.length) {
        away = [];
        tds.each((i, el) => { if (i < UNIT_KEYS.length) away[i] = parseInt((el.textContent || '0').trim(), 10) || 0; });
        while (away.length < UNIT_KEYS.length) away.push(0);
      }
    }

    // Jaké řádky chceme:
    // - když BRÁNÍŠ a zapisuješ k enemy útočníkovi → poslal/padlo/přežilo s 100% zkratkou
    // - když ÚTOČÍŠ a zapisuješ k enemy obránci → měl doma/padlo/přežilo + mimo
    const lines = [];
    let headerVecForClass = row2;

    if (iAmDef && side === 'att') {
      // bráním → enemy attacker
      if (vecEqual(row2, row3)) {
        lines.push(fmtLine(T.died100, row3));
      } else {
        lines.push(fmtLine(T.sent, row2));
        lines.push(fmtLine(T.died, row3));
        lines.push(fmtLine(T.survived, surv));
      }
    } else if (iAmAtt && side === 'def') {
      // útočím → enemy defender
      lines.push(fmtLine(T.home, row2));
      lines.push(fmtLine(T.died, row3));
      lines.push(fmtLine(T.survived, surv));
      if (away) lines.push(fmtLine(T.away, away));
      headerVecForClass = away ? vecSub(vecSub(row2, [0,0,0,0,0,0,0,0,0,0]), [0,0,0,0,0,0,0,0,0,0]) : row2; // jen aby byl definovaný
    } else {
      // nejednoznačné → použij “univerzální”
      lines.push(fmtLine('Stav', row2));
      lines.push(fmtLine(T.died, row3));
      lines.push(fmtLine(T.survived, surv));
      if (away) lines.push(fmtLine(T.away, away));
    }

    const headerInfo = classify(headerVecForClass, 'main');
    const note = buildNoteBlock(targetCoord || '???|???', headerInfo, lines, null);

    apiNoteEdit(targetId, note)
      .done(() => UI.SuccessMessage(T.noteCreated, 2500))
      .fail(() => UI.ErrorMessage('KZ: Nepovedlo se uložit poznámku (API).', 4000));
  }

  function start() {
    if (!verifyReportPage()) return;

    const { attName, defName } = getNamesAndVillageIds();
    const iAmDef = (defName === ME);
    const iAmAtt = (attName === ME);

    // Když je jasné, co jsi, udělej to automaticky:
    if (iAmDef && !iAmAtt) return runForSide('att'); // bráním → píš k útočníkovi
    if (iAmAtt && !iAmDef) return runForSide('def'); // útočím → píš k obránci

    // jinak dialog (stejně jako originál)
    const box = $('<div class="center"></div>').append(
      $('<div class="center"></div>').text(T.chooseSide),
      $('<div class="center" style="margin-top:10px;"></div>').append(
        $('<button class="btn btn-confirm-yes atk" style="margin-right:10px;"></button>').text(T.attacker),
        $('<button class="btn btn-confirm-yes def"></button>').text(T.defender)
      )
    );

    Dialog.show('kz_report_note', box);
    box.find('button.atk').on('click', () => { Dialog.close(); runForSide('att'); });
    box.find('button.def').on('click', () => { Dialog.close(); runForSide('def'); });
  }

  start();

})();
